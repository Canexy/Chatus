<!DOCTYPE html>
<html>
<head>
  <title>Chat Seguro ðŸ”’</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="authContainer">
    <h2>Registro / Login</h2>
    <input type="text" id="username" placeholder="Usuario" required>
    <input type="password" id="password" placeholder="ContraseÃ±a" required>
    <div class="auth-buttons">
      <button onclick="register()">Registrarse</button>
      <button onclick="login()">Iniciar SesiÃ³n</button>
    </div>
  </div>

  <div class="container" id="chatContainer" style="display: none;">
    <div class="header">
      <h1>Chat Seguro ðŸ”’</h1>
      <div class="header-buttons">
        <button onclick="showPasswordModal()">Cambiar ContraseÃ±a</button>
        <button onclick="logout()">Cerrar SesiÃ³n</button>
      </div>
    </div>
    
    <ul id="messages"></ul>
    
    <form id="form">
      <input id="input" placeholder="Escribe tu mensaje..." autocomplete="off" />
      <button>Enviar</button>
    </form>
  </div>

  <!-- Modal para cambiar contraseÃ±a -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hidePasswordModal()">&times;</span>
      <h3>Cambiar ContraseÃ±a</h3>
      <input type="password" id="currentPassword" placeholder="ContraseÃ±a actual">
      <input type="password" id="newPassword" placeholder="Nueva contraseÃ±a">
      <button onclick="changePassword()">Cambiar</button>
      <p id="passwordError" class="error-message"></p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let userId;
    let socket;

    async function checkAuth() {
      try {
        const response = await fetch('/check-auth');
        if (response.status === 200) {
          const data = await response.json();
          userId = data.userId;
          document.getElementById('authContainer').style.display = 'none';
          document.getElementById('chatContainer').style.display = 'block';
          initializeChat();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function register() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      const response = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      if (response.status === 201) alert('âœ… Registro exitoso');
      else alert('âŒ Error: ' + (await response.json()).error);
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      if (response.status === 200) checkAuth();
      else alert('ðŸ” Credenciales incorrectas');
    }

    function initializeChat() {
      socket = io();
      const DOM = {
        form: document.getElementById('form'),
        input: document.getElementById('input'),
        messages: document.getElementById('messages')
      };

      DOM.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = DOM.input.value.trim();
        if (message) {
          socket.emit('chat message', message);
          DOM.input.value = '';
        }
      });

      socket.on('chat message', (data) => {
        const li = document.createElement('li');
        li.className = data.uid === userId ? 'own-message' : 'other-message';
        li.innerHTML = `
          <div class="message-container">
            <strong>${data.user}:</strong>
            <div class="message-content">${data.text}</div>
          </div>
        `;
        DOM.messages.appendChild(li);
        DOM.messages.scrollTop = DOM.messages.scrollHeight;
      });
    }

    async function logout() {
      await fetch('/logout', { method: 'POST' });
      window.location.reload();
    }

    function showPasswordModal() {
      document.getElementById('passwordModal').style.display = 'block';
    }

    function hidePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordError').textContent = '';
    }

    async function changePassword() {
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      
      if (!current || !newPass) {
        document.getElementById('passwordError').textContent = 'Ambos campos son requeridos';
        return;
      }

      const response = await fetch('/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword: current, newPassword: newPass })
      });

      if (response.ok) {
        alert('âœ… ContraseÃ±a cambiada');
        hidePasswordModal();
      } else {
        const error = await response.json();
        document.getElementById('passwordError').textContent = error.error;
      }
    }

    checkAuth();
  </script>
</body>
</html>
